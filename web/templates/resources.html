<!DOCTYPE html>
<html>
	<head>
		<title>everytiān</title>
		<meta name="mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
    	<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.6.0/slick.css"/>
 		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.6.0/slick-theme.css"/>
		<style>

			body {
				font-family: "Helvetica Neue", Helvetica,Arial,sans-serif;
				overflow-y: hidden;
				margin: 0px;
			}

			.text {
				outline: none;
				font-size: 30pt;
				line-height: 45pt;
				margin-top: 15pt;
				margin-bottom: 15pt;
			}

			.text .word {
				padding-bottom: 1pt;
				font-size: 30pt;
			}

			button {
				padding: 0pt 20pt;
				height: 50px;
				margin-bottom: 10pt;
			    background-color: #d9d9d9;
			    border: none;
			    margin-right: 10pt;
			    color: #a5a5a5;
			    font-size: 15pt;
			    font-weight: bolder;
			}

			button:hover {
			    background-color: #bdc3c7;
			    color: white;
			}

			.translation {
				display: none;
			}

			.text .unknown{
				border-bottom: 3px solid #e74c3c;
			}

			.translation {
				outline: none;
				margin: 10pt 0pt;
			}

			.text .word{
				margin-right: 2pt;
			}

			.confirm, .edit, .finish {
				display: none;
			}
			.drag {
 				outline: none;
 				border: none;
 			}

 			.explain {
				border-top: 2px solid #bdc3c7;
				margin-top: 5px;
				position: fixed;
				background-color: white;
				bottom: 0;
				width: 100%;
				/*max-height: 150pt;*/
				/*overflow: scroll;*/

			}

			.explain .word {
				font-size: 30pt;
			}

			.explain .pronunciation {
				font-size: 15pt;
				margin-top: 0pt;
			}

			.explain .definition {
				float: left;
				clear: both;
				font-size: 13pt;
				list-style: none;
				margin-top: 20px;
			    padding: 0;
			}

			.actions {
				margin-top: 40px;
			}

			#translation {
				display: none;
				font-size: 15pt;
				clear: left;
				margin-top: 0pt;
				margin-bottom: 15pt;
			}

			nav {
				background-color: #f2f2f2;
				padding: 0pt;
				margin: 0pt;
				max-height: 100px;
				overflow: hidden;

			}

			nav .left-wrapper {
				float: left;
				display: none;

			}

			nav .left-wrapper select {
				height: 50px;
				font-size: 15pt;
				border: none;
				outline: none;
				padding-right: 5px;
				background-color: transparent;

			}

			nav .right-wrapper {
				float: right;
			}

			nav .right-wrapper ul {
				list-style-type: none;
				padding: 0px;
				margin: 0px;
				color: #a6a6a6;
			}

			nav .right-wrapper #translate {
				background-image: url("/static/assets/translate.svg");
			}

			nav .right-wrapper #translate:hover, nav .right-wrapper #translate.active {
				background-image: url("/static/assets/translate_active.svg");
				background-color: #bdc3c7;
			}

			nav .right-wrapper #twitter {
				background-image: url("/static/assets/twitter.svg");
				background-color: #1da1f3;

			}

			nav .right-wrapper #twitter:hover { 
    			background-color: #337ab7
			}

			nav .right-wrapper #favorite {
				background-image: url("/static/assets/favorite.svg");
			}

			nav .right-wrapper #favorite:hover, nav .right-wrapper #favorite.active {
				background-image: url("/static/assets/favorite_active.svg");
				background-color: #e74c3c;
			}

			nav .right-wrapper #sound {
				background-image: url("/static/assets/sound.svg");
			}

			nav .right-wrapper #sound:hover, nav .right-wrapper #sound.active {
				background-image: url("/static/assets/sound_active.svg");
				background-color: #bdc3c7;
			}

			nav .right-wrapper #edit {
				background-image: url("/static/assets/edit.svg");
			}

			nav .right-wrapper #edit:hover, nav .right-wrapper #edit.active {
				background-image: url("/static/assets/edit_active.svg");
				background-color: #bdc3c7;
			}

			nav .right-wrapper #ask {
				background-image: url("/static/assets/ask.svg");
			}

			nav .right-wrapper #ask:hover, nav .right-wrapper #ask.active {
				background-image: url("/static/assets/ask_active.svg");
				background-color: #bdc3c7;
			}

			nav .right-wrapper ul li {
				float: right;
				height: 50px;
				width: 50px;
				padding: 0px;
				margin: 0px;
				background-color: #d9d9d9;
				overflow: hidden;
			}

			.resource.drag {
				height: 1000pt;
			}


		</style>
	</head>
	<body>
		{% load static %}
		<nav>
			<div class="left-wrapper">
				<select>
					<option>Practice</option>
					<option>Favorites</option>
					<option>Evolution</option>
					<option>Settings</option>
				</select>
			</div>
			<div class="right-wrapper">
				<ul>
					<li id="twitter" onclick=" window.open('https://twitter.com/intent/tweet?url=http://everytian.com&hashtags=chinese&text=' + $('.text').data('string'), '_blank');"></li>
					<li id="edit" onclick="if($(this).hasClass('active')){ 
							$('#finish').hide();
							$('#continue-edition').hide();
							$('#confirm').hide();
							$('.slick-active').find('.text').attr('contenteditable','false');
							$('.slick-active').find('#translation').attr('contenteditable','false');
							$('.slick-active').find('.text').data('string', $('.slick-active').find('.text').data('backup'));
							var words = $('.slick-active').find('.text').data('backup').split(' ');
					  		show_words(words, $('.slick-active').find('.text'));
							$(this).removeClass('active');
						} else { 
							$(this).addClass('active'); 
							$('.slick-active').find('.text').text($('.slick-active').find('.text').data('string'));  
							$('.slick-active').find('.text').attr('contenteditable','true');  
							$('.slick-active').find('.translation').attr('contenteditable','true'); 
							$('#confirm').hide();
							$('#finish').show();
							$('#cancel').show();
							$(this).addClass('active')}"></li>
					<li id="ask" onclick="if($(this).hasClass('active')){
							$(this).removeClass('active');
							$('.slick-active').find('#question').hide()
						} else { 
							$('.slick-active').find('#question').show()
							$(this).addClass('active')
						};"></li>
					<li id="sound" onclick="if($(this).hasClass('active')){ $(this).removeClass('active'); $('.slick-active').find('audio')[0].pause(); $('audio')[0].currentTime = 0;} else { $(this).addClass('active'); $('.slick-active').find('audio')[0].play(); var sound_button = $(this); $('.slick-active').find('audio').on('ended', function(){ sound_button.removeClass('active');});};"></li>
					<li id="favorite" onclick="if($(this).hasClass('active')){ $(this).removeClass('active');} else { $(this).addClass('active')};"></li>
					<li id="translate" onclick="if(!$(this).hasClass('active')){ $('.slick-active').find('.translation').show(); $(this).addClass('active');} else { $('.slick-current').find('.translation').hide(); $(this).removeClass('active')};"></li>
				</ul>
			</div>
		</nav>
		<!-- <section class="section-actions">
			<div id="resource-level">
				<ul>
					<li id="sound"><img src="{% static 'speaker.png' %}"></li>
					<li id="tweet"><a href="https://twitter.com/intent/tweet?url=http://everytian.com&hashtags=chinese&text={{ tweet }}"><img src="{% static 'twitter.png' %}"></a></li>
					<li id="favorite"><img src="{% static 'like.png' %}"></li>
					<li id="translate"><img src="{% static 'translation.png' %}"></li>
				</ul>
			</div>
		</section> -->
		<div id="carru" data-slick='{"slidesToShow": 1, "slidesToScroll": 2}'>


		</div>
		<div class="explain" style="display: none;">
			<div class="word"></div>
			<div class="pronunciation"></div>
			<ul class="definition"></ul>
		</div>
		{% csrf_token %}
		<script   src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js" type="text/javascript"></script>
		<script type="text/javascript" src="{% static 'jquery.ui.touch-punch.min.js' %}"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.6.0/slick.js"></script>

		<script>

			$( ".explain" ).draggable({ axis: "y" });

			base_url = "http://{{ request.get_host }}{% url 'api_resources' %}"
			var dict = {};
			added_slicks = 0;

			$("#carru").slick({
   				speed: 300,
   				accessibility: false,
   				arrows: false,
   				infinite: false
 			});

			$('#carru').on('afterChange', function next_resource(event, slick, currentSlide){
			  if(current_slide_index + 2 <= currentSlide){
				$('#translate').removeClass('active');
				$('#favorite').removeClass('active');
				$('#sound').removeClass('active');
				$('#ask').removeClass('active');
				$('#edit').removeClass('active');
			  	console.log(currentSlide);
			  	window.history.replaceState("object or string", "Title", "{% url 'resources' %}/" + $(".slick-current").data("id"));
			  	get_next();

			  	// consider allowign back and forth
			  	$("#carru").slick('slickRemove', 0);
			  	$("#carru").slick('slickRemove', 0);
			  }
			});
 			
 			first_resource = true;

 			requested_resource_id = window.location.pathname.split("/")[2]
 			if(requested_resource_id) {
				get_next(requested_resource_id);
				first_resource = false;
			} else {
				get_next();
			}
 			get_next();
 			
 			current_slide_index = 0

			function get_next(resource_id) {
				var resource = $('<div class="resource drag"></div>');
				var sound = $('<div class="sound"></div>');
				var text = $('<div class="text"></div>');
				var translation = $('<div class="translation"></div>');

				
				var edit = $('<button id="continue-edition">Edit</button>').hide().click(function(evt) {
					edit.hide();
					$(evt.target).hide();
					text.text(text.data("string"));
					text.attr('contenteditable','true');
					translation.attr('contenteditable','true');
					// deactivate draggable
			  		confirm.hide();
			  		finish.show();
				});

				var finish = $('<button id="finish">Finish</button>').hide().click(function(evt) {
					finish.hide();
					text.data("string", text.text());
			  		var words = text.text().split(' ');
			  		show_words(words, text);
			  		get_definitions(words, dict);
					text.attr('contenteditable','false');
					translation.attr('contenteditable','false');
			  		edit.show();
			  		// activate draggable
			  		confirm.show();
			  	});

				var confirm = $('<button id="confirm">Confirm</button>').hide().click(function(evt) {
						new_text = {
							"text": text.data("string").split(' '),
							"translation": translation.text(),
							'csrfmiddlewaretoken': $( "[name='csrfmiddlewaretoken']" ).val()
						}
						confirm.text("Sending...")
					$.post(base_url + '/' + resource.data("id"), new_text, function(response) {
						confirm.hide();
						confirm.text("Confirm")
						edit.hide()
						$('#edit').removeClass('active');

					}, 'json');
				});

				var question = $('<div id="question"><h2>You will soon be able to ask questions to a techer!</h2></div>').hide()


				resource.append(text).append(sound).append(translation);
				resource.append(edit).append(finish).append(confirm).append(question);

				request_url = base_url;
				if(!(resource_id  === undefined)){
					request_url = request_url + "/" + resource_id;
				}
				$.getJSON( request_url, function( data ) {
					resource.data("id", data["id"]);
					text.data("string", data["text"].join(" "));
					text.data("backup", data["text"].join(" "));
					words = data["words"];
					for(i in words){
						dict[words[i]['hanzi']] = {
							'pronunciation': words[i]['pinyin'],
							'definitions': words[i]['definitions']
						}
					}
					show_words(data["text"], text, dict);
					// get_definitions(data["text"], dict)
					translation.text(data["translation"]);
					if(data["audio"]){
						sound.append('<audio><source src="https://audio.tatoeba.org/sentences/cmn/' + data["audio"] + '.mp3" type="audio/mpeg">Your browser does not support audio!</audio>');
					}
					if(added_slicks > 0){
						$("#carru").slick('slickAdd', "<div></div>");
						added_slicks += 1;
					}
					if(first_resource){
			  			window.history.replaceState("object or string", "Title", "{% url 'resources' %}/" + data["id"]);
						first_resource = false;
					}
					$("#carru").slick('slickAdd', resource);
					added_slicks += 1;
			  	});
		  	}

			function show_words(words, jQ_div, dict){
				jQ_div.empty();
		  		for(i in words) {
		  			word = words[i]
		  			new_word = $('<span class="word">'+ word + '</span>').click(on_word_click);
		  	// 		if(dict[word]){
			  // 			new_word.append('<span class="pronunciation">' + dict[word]['pronunciation'] + '</span>')
					// }
					jQ_div.append(new_word);
		  		};

		  // 		{% for word in text %}
				// 	<div class="word">
				// 		<div class="hanzi">{{ word.hanzi }}</div>
				// 		<input name="unknown" type="checkbox" value="{{ word.hanzi }}" class="hidden">
				// 		<span class="pronunciation" style="display: none;">{{ word.pinyin }}</span>
				// 	</div>
				// {% endfor %}

			}

			function get_definitions(words, dictionary){
				var punctuation = '…！？／（）、，。：「」…『』！？《》“”；’ ‘【】·〔〕.,?!-[]';
				for(i in words) { 
				 	if (!dictionary[words[i]] && !punctuation.includes(words[i])) {
				 		$.getJSON( "http://{{ request.get_host }}{% url 'api_words' %}/" + words[i], function(word) {
							if(word['hanzi']){
								dictionary[word['hanzi']] = {
									'pronunciation': word['pinyin'],
									'definitions': word['definitions']
								}
							} else {
								console.log(word['warning']);
							}
						});
					}
				}
			}

			// Explain

			function explain(word, pronunciation, definitions){
		  		$( ".explain").hide();
				$( ".explain .word" ).text(word);
				$( ".explain .pronunciation" ).text(pronunciation);
				def_list = $( ".explain .definition" ).empty();
				for(var i = 0; i < definitions.length; i++){
					def_list.append("<li>" + definitions[i] + "</li>");	
				};
				$( ".explain").show();
				// $("#corrector").height($( ".explain").height());
			}

			var last_touched="";

			function clear_explain(){
				$( ".explain .word" ).empty();
				$( ".explain .pronunciation" ).empty();
				$( ".explain .definition" ).empty();
			  	$( ".explain").hide();
				// $("#corrector").height(0);
			}

			function on_word_click(event) {
			  touched_word = $(this).text()
			  if(touched_word in dict) {
			  	if (last_touched == touched_word){
			  		if ($(this).hasClass( "unknown" )){
			  			$(this).removeClass( "unknown" );
			  			// $(this).next().prop('checked', false).next().hide();
			  			// $(this).find('.pronunciation').offset($(this).offset()).hide();
			  			clear_explain();
			  		} else {
			  			word_dict = dict[touched_word];
			  			explain(touched_word, word_dict["pronunciation"], word_dict["definitions"]);
			  			$(this).addClass( "unknown" );
			  			// console.log($(this).offset());
			  			// $(this).find('.pronunciation').offset($(this).offset()).show();
			  			// $(this).next().prop('checked', true).next().show();
			  		}
			  	} else {
			  		word_dict = dict[touched_word];
			  		explain(touched_word, word_dict["pronunciation"], word_dict["definitions"]);
			  		if (!$(this).hasClass("unknown")){
			  			$(this).addClass("unknown");
			  			// console.log($(this).offset());
			  			// $(this).find('.pronunciation').offset($(this).offset()).show();
			  			// $(this).next().prop('checked', true).next().show();
			  		}
			  	};
			  	last_touched = touched_word;
			  }
			};

		</script>
	</body>
</html>